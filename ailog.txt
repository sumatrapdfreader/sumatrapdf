create build.ts to be executed with bun that runs msbuild command to build
────
in build.ts remove ./out/dbg64/SumatraPDF.exe before running msbuild
────
in StrUtil.cpp and StrUtil.h implement:
struct Str {
  char* s;
  int len;
  Str();
  explicit Str(char* s);
  explicit Str(char* s, int len);
};
add StrL(s) macro that returns Str{s, (int)sizeof(s) - 1}
────
run bun add to add types for node and bun
────
in BaseUtil.cpp, BaseUtil.h add atomic counters and info to PoolAllocator
- count total number of allocation
- total amount of allocated memory
- max allocated memory between calls to Reset()
- max allocations between calls to Reset()
────
remove AtomicInt class from src/utils/BaseUtil.h and src/utils/BaseUtil.cpp
instead add a typedef AtomicInt = LONG and replace the use of AtomicInt methods with AtomicInt* functions that use Interlocked* win32 apis, for example void AtomicIntAdd(AtomicInt* atomicInt, int value), int AtomicIntGet(AtomicInt* atomicInt) etc.
────
add command-line arg -wc to build.ts
it recursively scans all files in src/ directory and calculates total number of lines for each file extension and prints the result for .cpp, .h, .c, .txt files
────
also print number of files per extension like: .cpp: 100 lines in 28 files
────
display the output in a table-like display, 3 columns, numbers are aligned right, print the header (ext,lines,files) first and then just numbers for each row

current stats:
 ext   lines  files
.cpp  101830    175
  .h   18207    147
  .c       8      1
.txt     190      2

────
add -fix-virt flag to build.ts. It reads all .cpp and .h files in src/ directory
uses regular expression to detect a pattern, where on the same line we have:
virtual ~CommandPaletteWnd() override
i.e. virtual .* override
in lines that match that it removes virtual and following whitespace
if not lines that match, leaves the file alone
if made changes write the changed file back, make sure to preserve original line endings (crlf or lf)
────
analyze src/CommandPalette.cpp, src/CommandPalette.h, src/Commands.h, src/Commands.cpp src/Accelerators.cpp src/Accelerators.h
In CommandPaletteWnd when showing commands we also want to show the accelerator key if any, on the right side of the command name
To do that we need to do custom painting in ListBox and paint command name on the left side and accelerator key on the right side
────
it doesn't work, doesn't show any commands at all
────
it works but it needs a few pixels of spacing between the lines
────
no change, the lines still overlap
────
looks good. now add 8px right padding to accelerator key
────
split src/WinGui/WinGui.cpp into multiple files, one file for each class
name the file after class name e.g. Wnd => src/WinGui/Wnd.cpp
update visual studio solution by running: go run . -premake
build by rnning: bun build.ts
────
I got a crash:
libmupdf.dll!add_char_to_line+0xd2 \mupdf\source\fitz\stext-device.c+397
libmupdf.dll!fz_add_stext_char_imp+0x7a2 \mupdf\source\fitz\stext-device.c+860
libmupdf.dll!fz_add_stext_char+0x5fe \mupdf\source\fitz\stext-device.c+955
libmupdf.dll!flush_actualtext+0x106 \mupdf\source\fitz\stext-device.c+1087
libmupdf.dll!fz_stext_begin_metatext+0xc3 \mupdf\source\fitz\stext-device.c+1343
libmupdf.dll!fz_begin_metatext+0x67 \mupdf\source\fitz\device.c+621
libmupdf.dll!begin_metatext+0x7d \mupdf\source\pdf\pdf-op-run.c+1682
libmupdf.dll!push_marked_content+0x246 \mupdf\source\pdf\pdf-op-run.c+2126
libmupdf.dll!pdf_process_BDC+0x54 \mupdf\source\pdf\pdf-interpret.c+1233
libmupdf.dll!pdf_process_keyword+0xc1e \mupdf\source\pdf\pdf-interpret.c+1517
libmupdf.dll!pdf_process_stream+0x1d3 \mupdf\source\pdf\pdf-interpret.c+1687
libmupdf.dll!pdf_process_raw_contents+0x10b \mupdf\source\pdf\pdf-interpret.c+1827
libmupdf.dll!pdf_process_contents+0x72 \mupdf\source\pdf\pdf-interpret.c+1850
libmupdf.dll!pdf_run_page_contents_with_usage_imp+0x567 \mupdf\source\pdf\pdf-run.c+188
libmupdf.dll!pdf_run_page_contents_with_usage+0xc7 \mupdf\source\pdf\pdf-run.c+226
libmupdf.dll!pdf_run_page_contents+0x30 \mupdf\source\pdf\pdf-run.c+240
libmupdf.dll!pdf_run_page_contents_imp+0x30 \mupdf\source\pdf\pdf-page.c+1114
libmupdf.dll!fz_run_page_contents+0x8d \mupdf\source\fitz\document.c+1024
libmupdf.dll!fz_new_stext_page_from_page_with_cookie+0xe4 \mupdf\source\fitz\util.c+311
sumatrapdf.exe!EngineMupdf::ExtractPageText+0xc7 \src\EngineMupdf.cpp+3205

Most likely this line in stext-device.c:
	if (font->flags.is_bold)
crashes because font is null
analyze the code in mupdf/ directory stext-device.c, device.c, pdf-op-run.c, pdf-interpret.c and see if you can figure out sequence of actions that would lead to font being null
────
Analyze the code in ./src/previewer2
it's a dll for providing thumbnails to windows
instead of implementing thumbnails directly using Engine* classes, change the implementation to use SumatraPDF.exe executable to do the actual work
for each thumbnail create a unique, named pipe for bi-directional communication with SumatraPDF.exe process
launch SumatraPDF.exe with -preview-pipe <pipe_name>
SumatraPDF.exe waits for commands on the pipe and sends back thumbnail data
previewer sends the data via that pipe to sumatrapdf.exe
when thumnbnail is finished, terminate the process
Startup code for SumatraPDF.exe is in src/SumatraStartup.cpp and parsing of cmd-line args in src/Flags.cpp
────
Analyze the code in ./src/ifilter2
it's a dll for providing search of files via search ifilter to windows
instead of implementing the functionality directly using Engine* classes, change the implementation to use SumatraPDF.exe executable to do the actual work
for each thumbnail create a unique, named pipe for bi-directional communication with SumatraPDF.exe process
launch SumatraPDF.exe with -ifilter-pipe <pipe_name>
SumatraPDF.exe waits for commands on the pipe and sends back ifilter data
ifilter sends the data via that pipe to sumatrapdf.exe
when process is finished, terminate the SumatraPDF.exe
Startup code for SumatraPDF.exe is in src/SumatraStartup.cpp and parsing of cmd-line args in src/Flags.cpp
────
DONE: ifilter2 named pipe implementation
Implementation details:
- Added -ifilter-pipe <pipe_name> command-line argument in Flags.cpp/h
- Added RunIFilterPipeServer() in SumatraStartup.cpp to handle pipe requests
- Protocol: request sends magic(IFLT)+version+fileType+dataSize+fileData
- Response: magic(IFLR)+status+pageCount+author+title+date+pageTexts(UTF-16)
- Modified PdfFilter and EpubFilter to use pipe communication via ExtractDataViaPipe()
- DLL creates pipe server, launches SumatraPDF.exe as client, sends file data, receives extracted text/metadata
- SumatraPDF.exe connects to pipe, uses Engine* classes to extract data, sends response, exits
────
analyze the code in ./src/preview2 and finish conversion to using sumatrapdf.exe via pipe for rendering of pages
Need to remove all uses of Engine* classes, all LoadEngine() methods
must convert PageRenderer to also use sumatrapdf.exe via pipe instead of engine
potentially needs to extend the pipe protocol to pass requested page number, zoom and size in src/preview2/PdfPreview.cpp and src/SumatraStartup.cpp
remove #include of Enginebase.h, EngineAll, DocController.h
to verify it compiles after changes run: "bun .\build.ts -build-preview2"
────
extract functionality related to writing to / receiving from pipe from files in directory src/preview2/ into src/PreviewPipe.cpp and src/PreviewPipe.h
we want to be able to test pipe rendering functionality from SumatraPDF.exe so we need the sending functionality available there as well
────
add cmd-line arg -test-preview-pipe <file-name> that exercises all preview pipe functionality from src/PreviewPipe.cpp and src/PreviewPipe.h
src/Flags.cpp is where parsing of command-line arguments happens
src/SumatrapdfStartup.cpp is where we need to check for this argument and call the appropriate function to run the test
to test rendered pages, create empty directory pipe-preview-results and write out each rendered page as .png file (page1.png, page2.png, ...) in pipe-preview-results/ directory
to create PNG file use win32 apis
for other information, write pipe-preview-results/result.txt with information you get via preview pipe, formatted for human readability
────
I got a crash:
sumatrapdf.exe!TabsCtrl::WndProc+0x2b7 \src\wingui\TabsCtrl.cpp+599
sumatrapdf.exe!WndWindowProc+0x86 \src\wingui\Wnd.cpp+230
comctl32.dll!DefSubclassProc+0x14a

Exception: C0000005 EXCEPTION_ACCESS_VIOLATION
Faulting IP: 00007FF7A1AB5BD7 01:00000000000B4BD7 sumatrapdf.exe!TabsCtrl::WndProc+0x2b7 C:\Users\kjk\src\sumatrapdf\src\wingui\TabsCtrl.cpp+599
Fault writing address 0000027CFFDA3F10

log before crash:
CloseTab: tab: 0x0000027D010FE250 win: 0x0000027D01C6CAA0, hwndFrame: 0x2a058a, quitIfLast: 0
CloseWindow: win: 0x0000027D01C6CAA0, hwndFrame: 0x2a058a, quitIfLast: 0, forceClose: 0
SaveSettings
NotifyAboutFile: ignoring 'C:\Users\EscritÃ³rio Campiolo\AppData\Local\SumatraPDF\SumatraPDF-settings.txt'
NotifyAboutFile: ignoring 'C:\Users\EscritÃ³rio Campiolo\AppData\Local\SumatraPDF\SumatraPDF-settings.txt'
DeleteMainWindow: win: 0x0000027D01C6CAA0, hwndFrame: 0x00000000002A058A, hwndCanvas: 0x00000000001604FE, winIdx : 1, nWindowsLeft: 1
~MainWindow: delete tabsCtrl: 0x0000027CFFDA3DA0, HWND: 0x00000000001204B0
SaveSettings
CrashDumpExceptionHandler
CrashDumpThread
_uploadDebugReport

Analyze src/wingui/TabsCtrl.cpp and other relevant code (CloseTab, CloseWindow).
Is it possible that TriggerTabClosed() destroys HWND and TabsCtrl so when we return the tab is no longer valid?
If yes, add code after TriggerTabClose() that does FindMainWindowByHWND() and exits if not found.
────
debug -preview-pipe with     running under windb xas :`windbgx -Q -o -g ./out/dbg64/SumatraPDF.exe <arguments>`
────
I got a crash:

Exception: C0000005 EXCEPTION_ACCESS_VIOLATION
Faulting IP: 00007FFD0EFA8EFB 01:0000000000127EFB libmupdf.dll!fz_end_group+0x77 C:\Users\kjk\src\sumatrapdf\mupdf\source\fitz\device.c+467
Fault writing address 0000010AD2EF70C8

libmupdf.dll!fz_end_group+0x77 \mupdf\source\fitz\device.c+467
libmupdf.dll!pdf_run_xobject+0x926 \mupdf\source\pdf\pdf-op-run.c+2423
libmupdf.dll!pdf_run_Do_form+0x46 \mupdf\source\pdf\pdf-op-run.c+3073
libmupdf.dll!pdf_process_Do+0x113 \mupdf\source\pdf\pdf-interpret.c+1070
libmupdf.dll!pdf_process_keyword+0x92e \mupdf\source\pdf\pdf-interpret.c+1511
libmupdf.dll!pdf_process_stream+0x1d3 \mupdf\source\pdf\pdf-interpret.c+1687
libmupdf.dll!pdf_process_raw_contents+0x10b \mupdf\source\pdf\pdf-interpret.c+1827
libmupdf.dll!pdf_process_contents+0x72 \mupdf\source\pdf\pdf-interpret.c+1850
libmupdf.dll!pdf_run_page_contents_with_usage_imp+0x567 \mupdf\source\pdf\pdf-run.c+188
libmupdf.dll!pdf_run_page_with_usage+0xd8 \mupdf\source\pdf\pdf-run.c+402
sumatrapdf.exe!EngineMupdf::RenderPage+0x2ee \src\EngineMupdf.cpp+3003
────
analyze the code in mupdf/ directory device.c, pdf-op-run.c, pdf-interpret.c, pdf-run.c and see if you can figure out sequence of actions that would lead to font being null

The Vulnerable Code Path

The bug is in pdf_show_char (pdf-op-run.c:1266-1276). The render_direct path for uncacheable Type3 glyphs has no
try/catch around fz_render_t3_glyph_direct:

pdf_gsave(ctx, pr);
gstate->text.font = NULL;  // font set to NULL
fz_render_t3_glyph_direct(ctx, ...);  // CAN THROW - no protection
pr->dev->flags = old_flags;   // skipped on throw
pdf_grestore(ctx, pr);        // skipped on throw

Why Static PDFs Can't Easily Trigger the Crash

The crash is at fz_end_group (line 2386 in pdf_run_xobject), which means pdf_process_contents at line 2369 must have
returned normally. But:

1. All errors from the Type3 render_direct path are morphed SYNTAX→FORMAT by pdf_process_glyph (pdf-interpret.c:1960)
2. FORMAT errors are always rethrown by pdf_process_stream (not caught as SYNTAX)
3. This means pdf_process_contents always throws when the render_direct path fails
4. When it throws, the code jumps to fz_catch at line 2414, skipping fz_end_group

So the crash can't be caused by a simple error-handling imbalance from a malformed PDF structure. The device state
remains balanced for all error types.

Most Likely Crash Cause

The crash (WRITE violation at 0000010AD2EF70C8) is most likely a heap use-after-free or heap corruption that manifests
during fz_paint_pixmap/fz_blend_pixmap inside fz_draw_end_group. The corrupted memory was probably freed or
overwritten by an earlier operation during the transparency group's content processing. Possible triggers:

- OOM at a precise moment during pixmap allocation in fz_draw_begin_group (after push_stack but before state is fully
initialized)
- Heap corruption from a buffer overflow in glyph/image/pattern rendering within the Type3 procedure
- Race condition if SumatraPDF renders pages on multiple threads sharing font data
- Integer overflow in coordinate calculations causing out-of-bounds pixmap writes

The font being null observation is a side effect: if fz_render_t3_glyph_direct throws, pdf_grestore is skipped and
gstate->text.font stays NULL. This NULL font persists in the corrupted gstate stack and may contribute to later issues
if processing somehow continues.

Reproducing the Crash

To reproduce this crash, you would likely need:
1. The specific PDF file from the crash report (it may trigger a heap corruption that's specific to its content)
2. Running under a memory stress tool or specific memory layout
3. Possibly Address Sanitizer (-fsanitize=address) or Page Heap (gflags /p /enable SumatraPDF.exe /full) to catch the
root cause

Would you like me to add a protective fz_try/fz_catch around the fz_render_t3_glyph_direct call in pdf_show_char to
fix the missing error handling?
